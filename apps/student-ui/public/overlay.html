<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Controledu Overlay</title>
    <style>
      :root {
        --bg: #111319;
        --panel: rgba(22, 26, 34, 0.94);
        --panel-2: rgba(16, 19, 26, 0.92);
        --border: rgba(255, 255, 255, 0.12);
        --text: #eef2ff;
        --muted: #b0b7c8;
        --accent: #47a7ff;
        --accent-2: #6dc6ff;
        --ok: #5ed28f;
        --warn: #ffbf47;
        --danger: #ff6f6f;
        --shadow: 0 16px 40px rgba(0, 0, 0, 0.34);
        --font-scale: 1;
      }

      * { box-sizing: border-box; }
      html, body {
        margin: 0;
        width: 100%;
        height: 100%;
        background: transparent;
        color: var(--text);
        font-family: "Segoe UI", system-ui, sans-serif;
        font-size: calc(14px * var(--font-scale));
        overflow: hidden;
      }

      body {
        padding: 0;
        cursor: default;
      }

      body.large-cursor * {
        cursor: pointer;
      }

      #app {
        width: 100%;
        height: 100%;
        display: grid;
        grid-template-rows: auto auto auto auto 1fr auto;
        gap: 0.55rem;
        padding: 0.6rem;
        border: 1px solid var(--border);
        border-radius: 1rem;
        background:
          radial-gradient(circle at 100% 0%, rgba(71, 167, 255, 0.18), transparent 56%),
          radial-gradient(circle at 0% 100%, rgba(94, 210, 143, 0.14), transparent 60%),
          linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0)),
          var(--bg);
        box-shadow: var(--shadow);
        overflow-y: auto;
        overflow-x: hidden;
        overscroll-behavior: contain;
        scrollbar-gutter: stable;
      }

      body.collapsed-overlay #app {
        grid-template-rows: auto auto auto;
        gap: 0.45rem;
      }

      #app,
      .messages,
      #chatInput {
        scrollbar-width: thin;
        scrollbar-color: rgba(109, 198, 255, 0.52) rgba(255, 255, 255, 0.04);
      }

      #app::-webkit-scrollbar,
      .messages::-webkit-scrollbar,
      #chatInput::-webkit-scrollbar {
        width: 10px;
        height: 10px;
      }

      #app::-webkit-scrollbar-track,
      .messages::-webkit-scrollbar-track,
      #chatInput::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.03);
        border-radius: 999px;
      }

      #app::-webkit-scrollbar-thumb,
      .messages::-webkit-scrollbar-thumb,
      #chatInput::-webkit-scrollbar-thumb {
        border-radius: 999px;
        border: 2px solid transparent;
        background:
          linear-gradient(180deg, rgba(141,216,255,0.88), rgba(71,167,255,0.82)) padding-box;
        background-clip: padding-box;
      }

      .drag-grip {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.45rem;
        min-height: 1.35rem;
        border-radius: 0.75rem;
        border: 1px dashed rgba(255,255,255,0.14);
        background: rgba(255,255,255,0.02);
        color: var(--muted);
        cursor: grab;
        user-select: none;
        font-size: 0.72rem;
      }

      .drag-grip:active {
        cursor: grabbing;
      }

      .drag-dots {
        width: 1.4rem;
        height: 0.28rem;
        border-radius: 999px;
        background:
          radial-gradient(circle, rgba(176,183,200,0.95) 35%, transparent 38%) 0 0 / 0.34rem 0.28rem repeat-x;
      }

      .sr-only {
        position: absolute !important;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
      }

      .header {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 0.75rem;
        padding: 0.7rem 0.8rem;
        border-radius: 0.85rem;
        border: 1px solid var(--border);
        background: var(--panel);
      }

      .header-actions {
        display: flex;
        align-items: center;
        gap: 0.45rem;
        flex-wrap: wrap;
        justify-content: flex-end;
      }

      .lang-switch {
        display: inline-flex;
        align-items: center;
        gap: 0.2rem;
        padding: 0.15rem;
        border-radius: 0.65rem;
        border: 1px solid rgba(255,255,255,0.1);
        background: rgba(255,255,255,0.02);
      }

      .lang-btn {
        min-width: 2rem;
        height: 1.85rem;
        border-radius: 0.5rem;
        border: 1px solid transparent;
        background: transparent;
        color: var(--muted);
        font: inherit;
        font-size: 0.72rem;
        font-weight: 700;
        text-transform: uppercase;
      }

      .lang-btn[aria-pressed="true"] {
        color: var(--text);
        border-color: rgba(71,167,255,0.35);
        background: rgba(71,167,255,0.12);
      }

      .icon-btn {
        border: 1px solid rgba(255,255,255,0.12);
        background: rgba(255,255,255,0.04);
        color: var(--text);
        border-radius: 0.65rem;
        min-width: 2.1rem;
        height: 2.1rem;
        padding: 0 0.5rem;
        font: inherit;
        font-weight: 700;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }

      .icon-btn:hover {
        border-color: rgba(71,167,255,0.35);
        background: rgba(71,167,255,0.08);
      }

      .title-wrap h1 {
        margin: 0;
        font-size: 1rem;
        font-weight: 700;
        letter-spacing: 0.01em;
      }

      .title-wrap p {
        margin: 0.2rem 0 0;
        color: var(--muted);
        font-size: 0.82rem;
      }

      .pill {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.32rem 0.55rem;
        border-radius: 999px;
        border: 1px solid rgba(255,255,255,0.14);
        background: rgba(255,255,255,0.03);
        color: var(--muted);
        font-size: 0.74rem;
        white-space: nowrap;
      }

      .pill .dot {
        width: 0.42rem;
        height: 0.42rem;
        border-radius: 50%;
        background: var(--ok);
        box-shadow: 0 0 0 0.22rem rgba(94, 210, 143, 0.15);
      }

      .toolbar {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 0.55rem;
        align-items: stretch;
      }

      .raise-button {
        border: 1px solid rgba(71, 167, 255, 0.34);
        background:
          linear-gradient(180deg, rgba(71,167,255,0.22), rgba(71,167,255,0.13)),
          rgba(71,167,255,0.07);
        color: #f5fbff;
        border-radius: 0.85rem;
        padding: 0.8rem 0.9rem;
        font: inherit;
        font-weight: 700;
        text-align: left;
        display: grid;
        gap: 0.2rem;
        min-height: 3.35rem;
      }

      .raise-button small {
        color: rgba(238, 242, 255, 0.78);
        font-weight: 500;
        font-size: 0.78rem;
      }

      .raise-button:hover:not(:disabled) {
        border-color: rgba(109, 198, 255, 0.5);
        transform: translateY(-1px);
      }

      .raise-button:active:not(:disabled) {
        transform: translateY(0);
      }

      .raise-button:disabled {
        opacity: 0.65;
      }

      .font-panel {
        min-width: 8.8rem;
        border-radius: 0.85rem;
        border: 1px solid var(--border);
        background: var(--panel);
        padding: 0.55rem 0.65rem;
        display: grid;
        gap: 0.35rem;
      }

      .font-panel label {
        font-size: 0.74rem;
        color: var(--muted);
        display: flex;
        justify-content: space-between;
        gap: 0.4rem;
      }

      .font-hint {
        font-size: 0.68rem;
        color: var(--muted);
      }

      .font-panel input[type="range"] {
        width: 100%;
        appearance: none;
        -webkit-appearance: none;
        background: transparent;
      }

      .font-panel input[type="range"]::-webkit-slider-runnable-track {
        height: 0.42rem;
        border-radius: 999px;
        border: 1px solid rgba(255,255,255,0.08);
        background: linear-gradient(90deg, rgba(71,167,255,0.24), rgba(109,198,255,0.38));
      }

      .font-panel input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 0.95rem;
        height: 0.95rem;
        margin-top: -0.33rem;
        border-radius: 50%;
        border: 1px solid rgba(255,255,255,0.28);
        background: radial-gradient(circle at 28% 28%, #ffffff, #8fd8ff 66%, #47a7ff);
        box-shadow: 0 2px 10px rgba(0,0,0,0.25);
      }

      .font-panel input[type="range"]::-moz-range-track {
        height: 0.42rem;
        border-radius: 999px;
        border: 1px solid rgba(255,255,255,0.08);
        background: linear-gradient(90deg, rgba(71,167,255,0.24), rgba(109,198,255,0.38));
      }

      .font-panel input[type="range"]::-moz-range-thumb {
        width: 0.95rem;
        height: 0.95rem;
        border-radius: 50%;
        border: 1px solid rgba(255,255,255,0.28);
        background: radial-gradient(circle at 28% 28%, #ffffff, #8fd8ff 66%, #47a7ff);
        box-shadow: 0 2px 10px rgba(0,0,0,0.25);
      }

      .chat-panel {
        min-height: 0;
        display: grid;
        grid-template-rows: auto 1fr;
        border-radius: 0.95rem;
        border: 1px solid var(--border);
        background: var(--panel-2);
        overflow: hidden;
      }

      .caption-panel {
        border-radius: 0.9rem;
        border: 1px solid rgba(109, 198, 255, 0.28);
        background:
          radial-gradient(circle at 100% 0%, rgba(109,198,255,0.14), transparent 58%),
          linear-gradient(180deg, rgba(71,167,255,0.1), rgba(71,167,255,0.03)),
          rgba(255,255,255,0.025);
        padding: 0.7rem 0.8rem;
        display: grid;
        gap: 0.45rem;
        min-height: 0;
        box-shadow: inset 0 0 0 1px rgba(255,255,255,0.03);
      }

      .caption-panel[data-visible="false"] {
        display: none;
      }

      .caption-panel[data-has-text="false"] {
        border-style: dashed;
        border-color: rgba(255,255,255,0.14);
        background:
          linear-gradient(180deg, rgba(255,255,255,0.025), rgba(255,255,255,0.01)),
          rgba(255,255,255,0.01);
      }

      .caption-panel[data-final="false"] {
        border-color: rgba(255,191,71,0.24);
        background:
          linear-gradient(180deg, rgba(255,191,71,0.08), rgba(255,191,71,0.03)),
          rgba(255,255,255,0.02);
      }

      .caption-head {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.5rem;
        color: var(--muted);
        font-size: 0.72rem;
      }

      .caption-head strong {
        color: var(--text);
        font-size: 0.74rem;
        font-weight: 700;
        letter-spacing: 0.02em;
      }

      .caption-text {
        margin: 0;
        min-height: 2.7em;
        line-height: 1.42;
        font-size: 1.06rem;
        font-weight: 700;
        color: var(--text);
        word-break: break-word;
        letter-spacing: 0.01em;
      }

      .caption-panel[data-has-text="false"] .caption-text {
        color: var(--muted);
        font-weight: 500;
      }

      .caption-meta {
        color: var(--muted);
        font-size: 0.7rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      body:not(.collapsed-overlay) .chat-panel {
        min-height: 8.5rem;
      }

      body.collapsed-overlay .chat-panel,
      body.collapsed-overlay .caption-panel,
      body.collapsed-overlay .composer,
      body.collapsed-overlay .status-bar,
      body.collapsed-overlay .font-panel,
      body.collapsed-overlay .font-panel .font-hint {
        display: none;
      }

      body.collapsed-overlay .caption-panel {
        padding-block: 0.5rem;
      }

      body.collapsed-overlay .raise-button {
        min-height: 2.65rem;
        padding-top: 0.55rem;
        padding-bottom: 0.55rem;
      }

      body.collapsed-overlay .raise-button small {
        display: none;
      }

      body.collapsed-overlay .title-wrap p {
        display: none;
      }

      body.collapsed-overlay .header {
        align-items: center;
        padding-top: 0.55rem;
        padding-bottom: 0.55rem;
      }

      body.collapsed-overlay .title-wrap {
        min-width: 0;
      }

      body.collapsed-overlay .title-wrap h1 {
        font-size: 0.9rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      body.collapsed-overlay .lang-switch {
        display: none;
      }

      body.collapsed-overlay #teacherStatusText {
        display: none;
      }

      body.collapsed-overlay .pill {
        padding-inline: 0.35rem;
      }

      body.collapsed-overlay #dragGrip {
        min-height: 1rem;
      }

      body.collapsed-overlay #dragGripText {
        display: none;
      }

      .chat-panel-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 0.75rem;
        padding: 0.7rem 0.8rem;
        border-bottom: 1px solid rgba(255,255,255,0.07);
        background: rgba(255,255,255,0.02);
      }

      .chat-panel-header strong {
        font-size: 0.84rem;
        letter-spacing: 0.02em;
      }

      .chat-status {
        font-size: 0.72rem;
        color: var(--muted);
      }

      .messages {
        overflow: auto;
        padding: 0.75rem;
        display: grid;
        gap: 0.5rem;
        align-content: start;
        background:
          linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0)),
          transparent;
      }

      .messages.flash {
        animation: flash-ring 900ms ease-out;
      }

      @keyframes flash-ring {
        0% { box-shadow: inset 0 0 0 0 rgba(71,167,255,0.25); }
        100% { box-shadow: inset 0 0 0 14px rgba(71,167,255,0); }
      }

      .empty-state {
        color: var(--muted);
        font-size: 0.84rem;
        border: 1px dashed rgba(255,255,255,0.11);
        border-radius: 0.75rem;
        padding: 0.9rem;
        text-align: center;
        background: rgba(255,255,255,0.02);
      }

      .bubble {
        max-width: 92%;
        border-radius: 0.9rem;
        padding: 0.58rem 0.7rem;
        border: 1px solid rgba(255,255,255,0.08);
        background: rgba(255,255,255,0.03);
        display: grid;
        gap: 0.22rem;
      }

      .bubble[data-role="teacher"] {
        justify-self: start;
        background: linear-gradient(180deg, rgba(71,167,255,0.13), rgba(71,167,255,0.05));
        border-color: rgba(71, 167, 255, 0.22);
      }

      .bubble[data-role="student"] {
        justify-self: end;
        background: linear-gradient(180deg, rgba(94,210,143,0.13), rgba(94,210,143,0.05));
        border-color: rgba(94, 210, 143, 0.22);
      }

      .bubble-meta {
        display: flex;
        gap: 0.4rem;
        align-items: center;
        justify-content: space-between;
        font-size: 0.68rem;
        color: var(--muted);
      }

      .bubble-author {
        font-weight: 600;
        color: inherit;
      }

      .bubble-text {
        white-space: pre-wrap;
        line-height: 1.38;
        word-break: break-word;
        color: var(--text);
      }

      .composer {
        display: grid;
        gap: 0.42rem;
        border: 1px solid var(--border);
        border-radius: 0.95rem;
        background: var(--panel);
        padding: 0.65rem;
      }

      .composer textarea {
        width: 100%;
        min-height: 4.8rem;
        max-height: 9.5rem;
        resize: vertical;
        border-radius: 0.7rem;
        border: 1px solid rgba(255,255,255,0.12);
        background: rgba(255,255,255,0.025);
        color: var(--text);
        padding: 0.65rem 0.7rem;
        font: inherit;
        line-height: 1.35;
      }

      .composer textarea::placeholder {
        color: #9ea8bb;
      }

      .composer-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.55rem;
      }

      .composer-tools {
        display: flex;
        gap: 0.45rem;
        align-items: center;
        color: var(--muted);
        font-size: 0.73rem;
      }

      .send-btn {
        border: 1px solid rgba(255,255,255,0.12);
        background:
          linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.02)),
          rgba(255,255,255,0.01);
        color: var(--text);
        border-radius: 0.7rem;
        min-height: 2.2rem;
        padding: 0.45rem 0.85rem;
        font: inherit;
        font-weight: 700;
      }

      .send-btn.primary {
        border-color: rgba(71,167,255,0.32);
        background:
          linear-gradient(180deg, rgba(71,167,255,0.24), rgba(71,167,255,0.08)),
          rgba(71,167,255,0.05);
      }

      .send-btn:disabled {
        opacity: 0.55;
      }

      .status-bar {
        border-radius: 0.75rem;
        border: 1px solid var(--border);
        background: rgba(255,255,255,0.02);
        padding: 0.45rem 0.6rem;
        font-size: 0.75rem;
        color: var(--muted);
      }

      .status-bar[data-tone="success"] { color: #b8ffd6; border-color: rgba(94,210,143,0.25); }
      .status-bar[data-tone="warn"] { color: #ffe1a7; border-color: rgba(255,191,71,0.25); }
      .status-bar[data-tone="error"] { color: #ffc2c2; border-color: rgba(255,111,111,0.25); }

      .focus-strong :focus-visible,
      .focus-strong:focus-visible {
        outline: 2px solid rgba(71, 167, 255, 0.9);
        outline-offset: 2px;
      }

      body.contrast-aa {
        --bg: #090b0f;
        --panel: rgba(12, 15, 20, 0.97);
        --panel-2: rgba(8, 10, 14, 0.97);
        --border: rgba(255,255,255,0.2);
        --text: #ffffff;
        --muted: #d7dced;
      }

      body.contrast-aaa {
        --bg: #000000;
        --panel: rgba(0, 0, 0, 0.985);
        --panel-2: rgba(0, 0, 0, 0.985);
        --border: rgba(255,255,255,0.32);
        --text: #ffffff;
        --muted: #f0f0f0;
        --accent: #8fd8ff;
        --accent-2: #b5e8ff;
      }

      body.dyslexia-font {
        font-family: "OpenDyslexic", "Comic Sans MS", "Verdana", sans-serif;
      }

      body.invert-colors {
        filter: invert(1) hue-rotate(180deg);
      }

      body.large-buttons .raise-button,
      body.large-buttons .send-btn {
        min-height: 2.7rem;
        padding-top: 0.65rem;
        padding-bottom: 0.65rem;
      }

      @media (prefers-reduced-motion: reduce) {
        * { animation: none !important; transition: none !important; }
      }
    </style>
  </head>
  <body class="focus-strong">
    <div id="app" aria-live="off">
      <div id="dragGrip" class="drag-grip" role="button" tabindex="0" aria-label="Drag overlay">
        <span class="drag-dots" aria-hidden="true"></span>
        <span id="dragGripText">Drag overlay</span>
      </div>
      <div class="header" role="region" aria-label="Статус оверлея">
        <div class="title-wrap">
          <h1>Помощь и чат с учителем</h1>
          <p>Быстрый вызов учителя и сообщения поверх экрана</p>
        </div>
        <div class="header-actions">
          <div id="langSwitch" class="lang-switch" role="group" aria-label="Overlay language">
            <button class="lang-btn focus-strong" type="button" data-lang="ru" aria-pressed="false">RU</button>
            <button class="lang-btn focus-strong" type="button" data-lang="en" aria-pressed="false">EN</button>
            <button class="lang-btn focus-strong" type="button" data-lang="kz" aria-pressed="false">KZ</button>
          </div>
          <button id="toggleCollapseBtn" class="icon-btn focus-strong" type="button" aria-expanded="false" aria-controls="chatPanel composer statusBar">+</button>
          <div class="pill" id="teacherStatusPill">
            <span class="dot" aria-hidden="true"></span>
            <span id="teacherStatusText">Connecting...</span>
          </div>
        </div>
      </div>

      <div class="toolbar">
        <button id="raiseHandBtn" class="raise-button focus-strong" type="button">
          <span>Поднять руку</span>
          <small id="raiseHandSub">Запросить помощь у учителя</small>
        </button>

        <div class="font-panel" role="group" aria-labelledby="fontScaleLabel">
          <label id="fontScaleLabel">
            <span>Размер текста</span>
            <strong id="fontScaleValue">100%</strong>
          </label>
          <div class="font-hint">Chat UI</div>
          <input id="fontScaleRange" type="range" min="80" max="220" step="5" value="100" />
        </div>
      </div>

      <section
        id="captionPanel"
        class="caption-panel"
        role="region"
        aria-label="Live captions"
        data-visible="false"
        data-has-text="false"
        data-final="true"
      >
        <div class="caption-head">
          <strong id="captionState">Live subtitles</strong>
          <span id="captionMeta" class="caption-meta"></span>
        </div>
        <p id="captionText" class="caption-text">Live subtitles will appear here</p>
      </section>

      <section id="chatPanel" class="chat-panel" aria-labelledby="chatPanelTitle">
        <div class="chat-panel-header">
          <strong id="chatPanelTitle">Чат с учителем</strong>
          <div class="chat-status" id="chatPanelStatus">Загрузка сообщений…</div>
        </div>
        <div id="messages" class="messages" role="log" aria-live="polite" aria-relevant="additions text">
          <div class="empty-state">Сообщений пока нет. Напишите учителю или используйте кнопку “Поднять руку”.</div>
        </div>
      </section>

      <form id="composer" class="composer" novalidate>
        <label class="sr-only" for="chatInput">Сообщение учителю</label>
        <textarea id="chatInput" placeholder="Напишите вопрос учителю… (Enter для отправки, Shift+Enter — новая строка)" maxlength="2000"></textarea>
        <div class="composer-row">
          <div class="composer-tools">
            <span id="charCount">0 / 2000</span>
            <span aria-hidden="true">•</span>
            <span id="profileLabel">Профиль: стандарт</span>
          </div>
          <button id="sendBtn" class="send-btn primary focus-strong" type="submit">Отправить</button>
        </div>
      </form>

      <div id="statusBar" class="status-bar" data-tone="neutral" role="status" aria-live="polite">
        Overlay готовится…
      </div>
    </div>

    <script>
      (() => {
        const LANG_STORAGE_KEY = "controledu.student.lang";
        const COLLAPSE_STORAGE_KEY = "controledu.student.overlay.collapsed";
        const I18N = {
          ru: {
            overlayRegion: "Статус оверлея",
            dragOverlay: "Переместить оверлей",
            headerTitle: "Помощь и чат с учителем",
            headerSubtitle: "Быстрый вызов учителя и сообщения поверх экрана",
            raiseHand: "Поднять руку",
            raiseHelp: "Запросить помощь у учителя",
            textSize: "Размер текста",
            chatUi: "Чат",
            chatTitle: "Чат с учителем",
            loadingMessages: "Загрузка сообщений...",
            noMessagesYet: "Сообщений пока нет. Напишите учителю или используйте кнопку \"Поднять руку\".",
            noMessages: "Нет сообщений",
            messageToTeacher: "Сообщение учителю",
            messagePlaceholder: "Напишите вопрос учителю... (Enter для отправки, Shift+Enter — новая строка)",
            profilePrefix: "Профиль",
            send: "Отправить",
            sending: "Отправка...",
            overlayStarting: "Оверлей запускается...",
            preparingOverlay: "Подготовка оверлея...",
            overlayReadyConnecting: "Оверлей готов. Подключаем чат...",
            sessionError: "Ошибка сессии: {error}",
            overlayStartError: "Ошибка запуска оверлея: {error}",
            tokenError: "Не удалось получить локальный токен сессии.",
            teacherOnline: "Учитель на связи",
            teacherOffline: "Нет связи",
            connecting: "Подключение...",
            loadError: "Ошибка загрузки",
            chatUnavailable: "Чат недоступен: {error}",
            messagesSummary: "Сообщений: {count} · последнее {time}",
            teacher: "Учитель",
            you: "Вы",
            messageQueued: "Сообщение отправлено в очередь доставки.",
            sendMessageError: "Не удалось отправить сообщение: {error}",
            sendingSignal: "Отправка сигнала...",
            signalSent: "Сигнал учителю отправлен.",
            signalNotSent: "Сигнал не отправлен.",
            retryIn: "Повтор через {seconds}с",
            sendSignalError: "Не удалось отправить сигнал: {error}",
            saveTextSizeError: "Не удалось сохранить размер текста: {error}",
            collapseOverlay: "Свернуть оверлей",
            expandOverlay: "Развернуть оверлей",
            profileDefault: "стандарт",
            profileVision: "зрение",
            profileHearing: "слух",
            profileMotor: "моторика",
            profileDyslexia: "дислексия/СДВГ",
            profileCustom: "пользовательский",
          },
          en: {
            overlayRegion: "Overlay status",
            dragOverlay: "Drag overlay",
            headerTitle: "Help and chat with teacher",
            headerSubtitle: "Quick teacher call and messages over the screen",
            raiseHand: "Raise hand",
            raiseHelp: "Request help from teacher",
            textSize: "Text size",
            chatUi: "Chat",
            chatTitle: "Chat with teacher",
            loadingMessages: "Loading messages...",
            noMessagesYet: "No messages yet. Write to the teacher or use the \"Raise hand\" button.",
            noMessages: "No messages",
            messageToTeacher: "Message to teacher",
            messagePlaceholder: "Write a question to the teacher... (Enter to send, Shift+Enter for a new line)",
            profilePrefix: "Profile",
            send: "Send",
            sending: "Sending...",
            overlayStarting: "Overlay is starting...",
            preparingOverlay: "Preparing overlay...",
            overlayReadyConnecting: "Overlay ready. Connecting chat...",
            sessionError: "Session error: {error}",
            overlayStartError: "Overlay startup error: {error}",
            tokenError: "Failed to get local session token.",
            teacherOnline: "Teacher online",
            teacherOffline: "Offline",
            connecting: "Connecting...",
            loadError: "Load error",
            chatUnavailable: "Chat unavailable: {error}",
            messagesSummary: "Messages: {count} · latest {time}",
            teacher: "Teacher",
            you: "You",
            messageQueued: "Message queued for delivery.",
            sendMessageError: "Failed to send message: {error}",
            sendingSignal: "Sending signal...",
            signalSent: "Signal sent to teacher.",
            signalNotSent: "Signal was not sent.",
            retryIn: "Retry in {seconds}s",
            sendSignalError: "Failed to send signal: {error}",
            saveTextSizeError: "Failed to save text size: {error}",
            collapseOverlay: "Collapse overlay",
            expandOverlay: "Expand overlay",
            profileDefault: "standard",
            profileVision: "vision",
            profileHearing: "hearing",
            profileMotor: "motor",
            profileDyslexia: "dyslexia/ADHD",
            profileCustom: "custom",
          },
          kz: {
            overlayRegion: "Оверлей күйі",
            dragOverlay: "Оверлейді жылжыту",
            headerTitle: "Мұғаліммен көмек және чат",
            headerSubtitle: "Мұғалімді тез шақыру және экран үстіндегі хабарламалар",
            raiseHand: "Қол көтеру",
            raiseHelp: "Мұғалімнен көмек сұрау",
            textSize: "Мәтін өлшемі",
            chatUi: "Чат",
            chatTitle: "Мұғаліммен чат",
            loadingMessages: "Хабарламалар жүктелуде...",
            noMessagesYet: "Әзірге хабарлама жоқ. Мұғалімге жазыңыз немесе \"Қол көтеру\" батырмасын пайдаланыңыз.",
            noMessages: "Хабар жоқ",
            messageToTeacher: "Мұғалімге хабарлама",
            messagePlaceholder: "Мұғалімге сұрақ жазыңыз... (Жіберу үшін Enter, жаңа жол үшін Shift+Enter)",
            profilePrefix: "Профиль",
            send: "Жіберу",
            sending: "Жіберілуде...",
            overlayStarting: "Оверлей іске қосылуда...",
            preparingOverlay: "Оверлей дайындалуда...",
            overlayReadyConnecting: "Оверлей дайын. Чат қосылуда...",
            sessionError: "Сессия қатесі: {error}",
            overlayStartError: "Оверлейді іске қосу қатесі: {error}",
            tokenError: "Жергілікті сессия токенін алу мүмкін болмады.",
            teacherOnline: "Мұғалім байланыста",
            teacherOffline: "Байланыс жоқ",
            connecting: "Қосылу...",
            loadError: "Жүктеу қатесі",
            chatUnavailable: "Чат қолжетімсіз: {error}",
            messagesSummary: "Хабарламалар: {count} · соңғысы {time}",
            teacher: "Мұғалім",
            you: "Сіз",
            messageQueued: "Хабарлама жеткізу кезегіне жіберілді.",
            sendMessageError: "Хабарламаны жіберу мүмкін болмады: {error}",
            sendingSignal: "Сигнал жіберілуде...",
            signalSent: "Мұғалімге сигнал жіберілді.",
            signalNotSent: "Сигнал жіберілмеді.",
            retryIn: "{seconds}с кейін қайталау",
            sendSignalError: "Сигнал жіберу мүмкін болмады: {error}",
            saveTextSizeError: "Мәтін өлшемін сақтау мүмкін болмады: {error}",
            collapseOverlay: "Оверлейді жинау",
            expandOverlay: "Оверлейді ашу",
            profileDefault: "стандарт",
            profileVision: "көру",
            profileHearing: "есту",
            profileMotor: "моторика",
            profileDyslexia: "дислексия/СДВГ",
            profileCustom: "арнайы",
          },
        };

        const state = {
          token: null,
          clientId: "unpaired-endpoint",
          messages: [],
          prefs: { fontScalePercent: 100 },
          accessibility: null,
          lastThreadFingerprint: "",
          lastTeacherMessageId: null,
          pollingTimer: null,
          profileTimer: null,
          captionTimer: null,
          liveCaption: null,
          lastCaptionFingerprint: "",
          sending: false,
          raising: false,
          sessionReady: false,
          isCollapsed: true,
          lang: "ru",
        };

        const els = {
          dragGrip: document.getElementById("dragGrip"),
          dragGripText: document.getElementById("dragGripText"),
          header: document.querySelector(".header"),
          headerTitle: document.querySelector(".title-wrap h1"),
          headerSubtitle: document.querySelector(".title-wrap p"),
          raiseBtn: document.getElementById("raiseHandBtn"),
          raiseBtnLabel: document.querySelector("#raiseHandBtn > span"),
          raiseSub: document.getElementById("raiseHandSub"),
          teacherStatusText: document.getElementById("teacherStatusText"),
          fontScaleLabelText: document.querySelector("#fontScaleLabel > span"),
          fontScaleRange: document.getElementById("fontScaleRange"),
          fontScaleValue: document.getElementById("fontScaleValue"),
          fontHint: document.querySelector(".font-hint"),
          captionPanel: document.getElementById("captionPanel"),
          captionText: document.getElementById("captionText"),
          captionState: document.getElementById("captionState"),
          captionMeta: document.getElementById("captionMeta"),
          messages: document.getElementById("messages"),
          chatPanelTitle: document.getElementById("chatPanelTitle"),
          chatPanelStatus: document.getElementById("chatPanelStatus"),
          composer: document.getElementById("composer"),
          chatInputLabel: document.querySelector("label[for='chatInput']"),
          chatInput: document.getElementById("chatInput"),
          sendBtn: document.getElementById("sendBtn"),
          charCount: document.getElementById("charCount"),
          statusBar: document.getElementById("statusBar"),
          profileLabel: document.getElementById("profileLabel"),
          toggleCollapseBtn: document.getElementById("toggleCollapseBtn"),
          langButtons: Array.from(document.querySelectorAll("[data-lang]")),
        };

        const PROFILE_LABELS = {
          default: { ru: "стандарт", en: "standard", kz: "стандарт" },
          vision: { ru: "зрение", en: "vision", kz: "көру" },
          hearing: { ru: "слух", en: "hearing", kz: "есту" },
          motor: { ru: "моторика", en: "motor", kz: "моторика" },
          dyslexia: { ru: "дислексия/СДВГ", en: "dyslexia/ADHD", kz: "дислексия/СДВГ" },
          custom: { ru: "пользовательский", en: "custom", kz: "арнайы" },
        };

        function t(key) {
          return (I18N[state.lang] && I18N[state.lang][key]) || I18N.en[key] || key;
        }

        function fmt(key, values = {}) {
          let result = t(key);
          for (const [name, value] of Object.entries(values)) {
            result = result.replaceAll(`{${name}}`, String(value));
          }
          return result;
        }

        function updateProfileLabel(preset) {
          const key = String(preset || "default");
          const label = (PROFILE_LABELS[key] && PROFILE_LABELS[key][state.lang]) || key;
          els.profileLabel.textContent = `${t("profilePrefix")}: ${label}`;
        }

        function updateCollapseButtonCopy() {
          els.toggleCollapseBtn.textContent = state.isCollapsed ? "▾" : "▴";
          els.toggleCollapseBtn.setAttribute("aria-expanded", String(!state.isCollapsed));
          els.toggleCollapseBtn.setAttribute("aria-label", state.isCollapsed ? t("expandOverlay") : t("collapseOverlay"));
          els.toggleCollapseBtn.title = state.isCollapsed ? t("expandOverlay") : t("collapseOverlay");
        }

        function applyLanguage() {
          document.documentElement.lang = state.lang;
          if (els.header) {
            els.header.setAttribute("aria-label", t("overlayRegion"));
          }
          if (els.dragGrip) {
            els.dragGrip.setAttribute("aria-label", t("dragOverlay"));
          }
          if (els.dragGripText) els.dragGripText.textContent = t("dragOverlay");
          if (els.headerTitle) els.headerTitle.textContent = t("headerTitle");
          if (els.headerSubtitle) els.headerSubtitle.textContent = t("headerSubtitle");
          if (els.raiseBtnLabel) els.raiseBtnLabel.textContent = t("raiseHand");
          if (els.raiseSub && !state.raising) els.raiseSub.textContent = t("raiseHelp");
          if (els.fontScaleLabelText) els.fontScaleLabelText.textContent = t("textSize");
          if (els.fontHint) els.fontHint.textContent = t("chatUi");
          if (els.chatPanelTitle) els.chatPanelTitle.textContent = t("chatTitle");
          if (els.chatInputLabel) els.chatInputLabel.textContent = t("messageToTeacher");
          if (els.chatInput) {
            els.chatInput.placeholder = t("messagePlaceholder");
            els.chatInput.setAttribute("aria-label", t("messageToTeacher"));
          }
          els.langButtons.forEach((button) => {
            button.setAttribute("aria-pressed", String(button.getAttribute("data-lang") === state.lang));
          });
          updateCollapseButtonCopy();
          const preset = String(state.accessibility?.activePreset || "default");
          updateProfileLabel(preset);
          if (els.teacherStatusText && !state.lastThreadFingerprint) {
            els.teacherStatusText.textContent = t("connecting");
          }
          if (els.chatPanelStatus && !state.lastThreadFingerprint) {
            els.chatPanelStatus.textContent = t("loadingMessages");
          }
          if (els.statusBar && !state.sessionReady && els.statusBar.getAttribute("data-tone") !== "error") {
            els.statusBar.textContent = t("overlayStarting");
          }
          setSendBusy(state.sending);
          if (!state.raising) {
            setRaiseBusy(false);
          }
          renderMessages();
        }

        function setOverlayLanguage(lang, persist = true) {
          state.lang = lang === "en" || lang === "kz" ? lang : "ru";
          if (persist) {
            try {
              localStorage.setItem(LANG_STORAGE_KEY, state.lang);
            } catch {
              // Ignore localStorage write failures.
            }
          }
          applyLanguage();
        }

        function setStatus(text, tone = "neutral") {

          els.statusBar.textContent = text;
          els.statusBar.setAttribute("data-tone", tone);
        }

        function setTeacherStatus(text) {
          els.teacherStatusText.textContent = text;
        }

        function renderLiveCaption() {
          if (!els.captionPanel || !els.captionText || !els.captionState || !els.captionMeta) {
            return;
          }

          const captionsAllowed = !!state.accessibility?.features?.liveCaptionsEnabled;
          const caption = state.liveCaption;
          const hasText = !!(captionsAllowed && caption && caption.visible && String(caption.text || "").trim().length > 0);
          const panelVisible = captionsAllowed;

          els.captionPanel.setAttribute("data-visible", panelVisible ? "true" : "false");
          els.captionPanel.setAttribute("data-has-text", hasText ? "true" : "false");
          if (!panelVisible) {
            els.captionPanel.setAttribute("data-final", "true");
            els.captionText.textContent = "";
            els.captionState.textContent = "Live subtitles";
            els.captionMeta.textContent = "";
            return;
          }

          if (!hasText) {
            els.captionPanel.setAttribute("data-final", "true");
            els.captionText.textContent = "Live subtitles will appear here";
            els.captionState.textContent = "Live subtitles";
            els.captionMeta.textContent = "Waiting for speech";
            return;
          }

          const isFinal = caption.isFinal !== false;
          els.captionPanel.setAttribute("data-final", isFinal ? "true" : "false");
          els.captionText.textContent = String(caption.text || "");
          els.captionState.textContent = isFinal ? "Subtitles" : "Listening";

          const meta = [];
          if (caption.languageCode) {
            meta.push(String(caption.languageCode).toUpperCase());
          }
          const ts = caption.timestampUtc ? new Date(caption.timestampUtc) : null;
          if (ts && !Number.isNaN(ts.getTime())) {
            meta.push(ts.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit", second: "2-digit" }));
          }
          els.captionMeta.textContent = meta.join(" | ") || "Teacher speech";
        }

        function postHostMessage(payload) {
          try {
            const bridge = window.chrome && window.chrome.webview;
            if (bridge && typeof bridge.postMessage === "function") {
              bridge.postMessage(payload);
            }
          } catch {
            // Ignore when not running in WebView2.
          }
        }

        function applyCollapsedState(collapsed, persist = true) {
          state.isCollapsed = !!collapsed;
          document.body.classList.toggle("collapsed-overlay", state.isCollapsed);
          updateCollapseButtonCopy();

          if (persist) {
            try {
              localStorage.setItem(COLLAPSE_STORAGE_KEY, state.isCollapsed ? "1" : "0");
            } catch {
              // Ignore localStorage write failures.
            }
          }

          postHostMessage({ type: "overlayLayout", collapsed: state.isCollapsed });
        }

        async function fetchJson(url, init = {}) {
          const headers = new Headers(init.headers || {});
          if (state.token) {
            headers.set("X-Controledu-LocalToken", state.token);
          }
          const response = await fetch(url, { ...init, headers });
          const text = await response.text();
          if (!response.ok) {
            throw new Error(text || `Request failed (${response.status})`);
          }
          return text ? JSON.parse(text) : null;
        }

        async function ensureSession() {
          if (state.token) return;
          const session = await fetchJson("/api/session");
          state.token = session?.token || null;
          if (!state.token) {
            throw new Error(t("tokenError"));
          }
          state.sessionReady = true;
        }

        function applyAccessibility(profile) {
          state.accessibility = profile || null;
          const ui = profile?.ui || {};
          const features = profile?.features || {};

          document.body.classList.toggle("contrast-aa", ui.contrastMode === "aa");
          document.body.classList.toggle("contrast-aaa", ui.contrastMode === "aaa");
          document.body.classList.toggle("invert-colors", !!ui.invertColors);
          document.body.classList.toggle("dyslexia-font", !!ui.dyslexiaFontEnabled);
          document.body.classList.toggle("large-cursor", !!ui.largeCursorEnabled);
          document.body.classList.toggle("large-buttons", !!features.largeActionButtonsEnabled);
          document.body.classList.toggle("focus-strong", !!ui.highlightFocusEnabled);

          const filters = [];
          if (ui.invertColors) {
            filters.push("invert(1)", "hue-rotate(180deg)");
          }
          if (ui.colorBlindMode === "protanopia") {
            filters.push("sepia(0.22)", "saturate(0.75)", "hue-rotate(-12deg)");
          } else if (ui.colorBlindMode === "deuteranopia") {
            filters.push("sepia(0.15)", "saturate(0.7)", "hue-rotate(18deg)");
          } else if (ui.colorBlindMode === "tritanopia") {
            filters.push("saturate(0.82)", "hue-rotate(35deg)");
          }
          document.body.style.filter = filters.length ? filters.join(" ") : "";

          const profileScale = Math.max(80, Math.min(300, Number(ui.scalePercent || 100)));
          const localScale = Math.max(80, Math.min(220, Number(state.prefs.fontScalePercent || 100)));
          const combinedScale = (profileScale / 100) * (localScale / 100);
          document.documentElement.style.setProperty("--font-scale", String(combinedScale));

          const preset = String(profile?.activePreset || "default");
          updateProfileLabel(preset);
          renderLiveCaption();
        }

        function renderMessages() {
          const list = state.messages || [];
          if (!list.length) {
            els.messages.innerHTML = `<div class="empty-state">${t("noMessagesYet")}</div>`;
            els.chatPanelStatus.textContent = t("noMessages");
            return;
          }

          const wasNearBottom = Math.abs(els.messages.scrollHeight - els.messages.clientHeight - els.messages.scrollTop) < 48;
          els.messages.innerHTML = "";
          for (const message of list) {
            const bubble = document.createElement("article");
            bubble.className = "bubble";
            bubble.dataset.role = (message.senderRole || "").toLowerCase() === "teacher" ? "teacher" : "student";
            bubble.setAttribute("tabindex", "0");

            const meta = document.createElement("div");
            meta.className = "bubble-meta";
            const author = document.createElement("span");
            author.className = "bubble-author";
            author.textContent = message.senderDisplayName || (bubble.dataset.role === "teacher" ? t("teacher") : t("you"));
            const time = document.createElement("time");
            const d = new Date(message.timestampUtc);
            time.dateTime = Number.isNaN(d.getTime()) ? "" : d.toISOString();
            time.textContent = Number.isNaN(d.getTime()) ? "" : d.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
            meta.append(author, time);

            const text = document.createElement("div");
            text.className = "bubble-text";
            text.textContent = message.text || "";

            bubble.append(meta, text);
            els.messages.appendChild(bubble);
          }

          const last = list[list.length - 1];
          els.chatPanelStatus.textContent = fmt("messagesSummary", {
            count: list.length,
            time: new Date(last.timestampUtc).toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" }),
          });
          if (wasNearBottom || list.length < 4) {
            els.messages.scrollTop = els.messages.scrollHeight;
          }
        }

        function flashMessagesIfTeacherAdded(previousLastTeacherId) {
          const teacherMessages = state.messages.filter((m) => String(m.senderRole || "").toLowerCase() === "teacher");
          const lastTeacher = teacherMessages[teacherMessages.length - 1];
          if (!lastTeacher) return;
          if (previousLastTeacherId && lastTeacher.messageId === previousLastTeacherId) return;

          const visualAlerts = !!state.accessibility?.features?.visualAlertsEnabled;
          if (visualAlerts) {
            els.messages.classList.remove("flash");
            void els.messages.offsetWidth;
            els.messages.classList.add("flash");
            setTimeout(() => els.messages.classList.remove("flash"), 900);
          }
        }

        function updateCharCount() {
          const len = els.chatInput.value.length;
          els.charCount.textContent = `${len} / 2000`;
        }

        function setSendBusy(isBusy) {
          state.sending = isBusy;
          els.sendBtn.disabled = isBusy || !els.chatInput.value.trim();
          els.sendBtn.textContent = isBusy ? t("sending") : t("send");
        }

        function setRaiseBusy(isBusy, cooldownText = "") {
          state.raising = isBusy;
          els.raiseBtn.disabled = isBusy;
          els.raiseSub.textContent = cooldownText || t("raiseHelp");
        }

        async function pollThread() {
          try {
            await ensureSession();
            const thread = await fetchJson("/api/chat/thread");
            state.clientId = thread?.clientId || state.clientId;
            state.prefs = thread?.preferences || state.prefs;
            els.fontScaleRange.value = String(Math.max(80, Math.min(220, state.prefs.fontScalePercent || 100)));
            els.fontScaleValue.textContent = `${Math.max(80, Math.min(220, state.prefs.fontScalePercent || 100))}%`;

            const messages = Array.isArray(thread?.messages) ? thread.messages : [];
            const fingerprint = messages.map((m) => m.messageId).join("|");
            if (fingerprint !== state.lastThreadFingerprint) {
              const previousTeacherId = state.lastTeacherMessageId;
              state.messages = messages;
              state.lastThreadFingerprint = fingerprint;
              const teacherMessages = messages.filter((m) => String(m.senderRole || "").toLowerCase() === "teacher");
              state.lastTeacherMessageId = teacherMessages.length ? teacherMessages[teacherMessages.length - 1].messageId : null;
              renderMessages();
              flashMessagesIfTeacherAdded(previousTeacherId);
            }

            setTeacherStatus(t("teacherOnline"));
          } catch (error) {
            setTeacherStatus(t("teacherOffline"));
            els.chatPanelStatus.textContent = t("loadError");
            setStatus(fmt("chatUnavailable", { error: error.message || error }), "error");
          }
        }

        async function pollAccessibility() {
          try {
            await ensureSession();
            const profile = await fetchJson("/api/accessibility/profile");
            applyAccessibility(profile);
          } catch {
            // Keep current UI if profile read failed.
          }
        }

        async function pollLiveCaption() {
          try {
            const captionsAllowed = !!state.accessibility?.features?.liveCaptionsEnabled;
            if (!captionsAllowed && !state.liveCaption?.visible) {
              return;
            }

            await ensureSession();
            const caption = await fetchJson("/api/captions/live");
            const fingerprint = JSON.stringify([
              !!caption?.visible,
              caption?.captionId || "",
              Number(caption?.sequence || 0),
              caption?.isFinal !== false,
              caption?.text || "",
              caption?.languageCode || "",
            ]);
            if (fingerprint === state.lastCaptionFingerprint) {
              return;
            }

            state.liveCaption = caption || null;
            state.lastCaptionFingerprint = fingerprint;
            renderLiveCaption();
          } catch {
            // Keep last caption on transient failure; service TTL clears stale text.
          }
        }

        async function sendChatMessage() {
          const text = els.chatInput.value.trim();
          if (!text || state.sending) return;

          setSendBusy(true);
          try {
            await ensureSession();
            await fetchJson("/api/chat/messages", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ text }),
            });
            els.chatInput.value = "";
            updateCharCount();
            setStatus(t("messageQueued"), "success");
            await pollThread();
          } catch (error) {
            setStatus(fmt("sendMessageError", { error: error.message || error }), "error");
          } finally {
            setSendBusy(false);
          }
        }

        async function sendRaiseHand() {
          if (state.raising) return;
          setRaiseBusy(true, t("sendingSignal"));
          try {
            await ensureSession();
            const result = await fetchJson("/api/signals/raise-hand", { method: "POST" });
            if (result?.ok) {
              setStatus(t("signalSent"), "success");
              setRaiseBusy(false);
              return;
            }

            const message = result?.message || t("signalNotSent");
            setStatus(message, "warn");
            setRaiseBusy(true, message);
            const match = /(\d+)s/.exec(message);
            const seconds = match ? Number(match[1]) : 5;
            let left = Number.isFinite(seconds) ? seconds : 5;
            const timer = setInterval(() => {
              left -= 1;
              if (left <= 0) {
                clearInterval(timer);
                setRaiseBusy(false);
                return;
              }
              setRaiseBusy(true, fmt("retryIn", { seconds: left }));
            }, 1000);
          } catch (error) {
            setStatus(fmt("sendSignalError", { error: error.message || error }), "error");
            setRaiseBusy(false);
          }
        }

        let saveFontTimer = null;
        function scheduleFontSave(value) {
          if (saveFontTimer) clearTimeout(saveFontTimer);
          saveFontTimer = setTimeout(async () => {
            try {
              await ensureSession();
              state.prefs.fontScalePercent = value;
              els.fontScaleValue.textContent = `${value}%`;
              applyAccessibility(state.accessibility);
              await fetchJson("/api/chat/preferences", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ fontScalePercent: value }),
              });
            } catch (error) {
              setStatus(fmt("saveTextSizeError", { error: error.message || error }), "warn");
            }
          }, 250);
        }

        async function start() {
          try {
            const storedLang = localStorage.getItem(LANG_STORAGE_KEY);
            setOverlayLanguage(storedLang === "en" || storedLang === "kz" ? storedLang : "ru", false);
          } catch {
            setOverlayLanguage("ru", false);
          }

          try {
            const storedCollapsed = localStorage.getItem(COLLAPSE_STORAGE_KEY);
            applyCollapsedState(storedCollapsed !== "0", false);
          } catch {
            applyCollapsedState(true, false);
          }

          updateCharCount();
          setStatus(t("preparingOverlay"), "neutral");
          try {
            await ensureSession();
            setStatus(t("overlayReadyConnecting"), "success");
          } catch (error) {
            setStatus(fmt("sessionError", { error: error.message || error }), "error");
            return;
          }

          await Promise.allSettled([pollThread(), pollAccessibility(), pollLiveCaption()]);
          state.pollingTimer = setInterval(pollThread, 1200);
          state.profileTimer = setInterval(pollAccessibility, 3500);
          state.captionTimer = setInterval(pollLiveCaption, 1100);
        }

        els.composer.addEventListener("submit", (event) => {
          event.preventDefault();
          void sendChatMessage();
        });

        els.chatInput.addEventListener("input", () => {
          updateCharCount();
          els.sendBtn.disabled = state.sending || !els.chatInput.value.trim();
        });

        els.chatInput.addEventListener("keydown", (event) => {
          if (event.key === "Enter" && !event.shiftKey) {
            event.preventDefault();
            void sendChatMessage();
          }
        });

        els.raiseBtn.addEventListener("click", () => void sendRaiseHand());
        els.toggleCollapseBtn.addEventListener("click", () => applyCollapsedState(!state.isCollapsed));
        els.langButtons.forEach((button) => {
          button.addEventListener("click", () => setOverlayLanguage(button.getAttribute("data-lang") || "ru"));
        });
        if (els.dragGrip) {
          const startDrag = (event) => {
            if ((event.type === "pointerdown" && event.button !== 0)) return;
            if (event.type === "keydown" && event.key !== "Enter" && event.key !== " ") return;
            event.preventDefault();
            postHostMessage({ type: "overlayDragStart" });
          };
          els.dragGrip.addEventListener("pointerdown", startDrag);
          els.dragGrip.addEventListener("keydown", startDrag);
        }

        els.fontScaleRange.addEventListener("input", () => {
          const value = Number(els.fontScaleRange.value);
          els.fontScaleValue.textContent = `${value}%`;
          state.prefs.fontScalePercent = value;
          applyAccessibility(state.accessibility);
          scheduleFontSave(value);
        });

        window.addEventListener("beforeunload", () => {
          if (state.pollingTimer) clearInterval(state.pollingTimer);
          if (state.profileTimer) clearInterval(state.profileTimer);
          if (state.captionTimer) clearInterval(state.captionTimer);
        });

        start().catch((error) => {
          setStatus(fmt("overlayStartError", { error: error.message || error }), "error");
        });
      })();
    </script>
  </body>
</html>



