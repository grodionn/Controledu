# Обзор ML-детекции

В Controledu используется каскадный детектор, который работает на каждом управляемом устройстве (`Student.Agent`) и отправляет компактные события в `Teacher.Server`.

## Почему детекция выполняется на стороне `Student.Agent`

- Меньше трафика: полноразмерные скриншоты не отправляются на сервер постоянно для анализа.
- Лучше контекст: агент на устройстве может дешево читать метаданные активного процесса/окна.
- Лучше масштабирование: один teacher-сервер может обслуживать больше клиентов.
- Лучше приватность: по умолчанию сервер хранит события/аудит, а не полный архив экранов.

## Стадии каскада

1. `Stage A` - фильтр изменения кадра (`PerceptualHashChangeFilter`)
- Вычисляет перцептивный хеш для каждого кадра.
- Пропускает тяжелые проверки, если кадр не изменился.
- Принудительно выполняет периодическую перепроверку через `MinRecheckIntervalSeconds`.

2. `Stage B` - правила по метаданным (`WindowMetadataDetector`)
- Использует заголовок активного окна/процесс/подсказку URL.
- Проверяет настроенные ключевые слова и whitelist-ключевые слова.
- Формирует класс + confidence + причину.

3. `Stage C` - ONNX-инференс (`OnnxBinaryAiDetector`, `OnnxMulticlassAiDetector`)
- Необязательный этап модели.
- Автоматически отключается, если файлы модели отсутствуют.
- Пайплайн продолжает работу на Stage A/B/D без падения.

4. `Stage D` - временная стабилизация (`TemporalVotingSmoother`)
- Голосование по последним N результатам.
- Пример значения по умолчанию: 2 положительных из 3 наблюдений.
- Cooldown подавляет повторяющиеся дублирующие алерты.

## Поток выполнения (runtime)

1. Агент захватывает кадр + метаданные.
2. `DetectionPipeline` формирует результат.
3. Стабильный положительный результат создает `AlertEventDto`.
4. Сервер сохраняет событие и отправляет live-обновление в Teacher UI.
5. Teacher UI показывает live-ленту + таблицу + фильтры.

## Ключевые места в коде

- Контракты и настройки: `src/Controledu.Detection.Abstractions`
- Пайплайн и правила: `src/Controledu.Detection.Core`
- ONNX-адаптеры: `src/Controledu.Detection.Onnx`
- Интеграция в агент: `src/Controledu.Student.Agent/Worker.cs`
- Teacher API/события: `src/Controledu.Teacher.Server/Controllers/DetectionController.cs`
- Страница Teacher UI: `apps/teacher-ui/src/App.tsx` (представление `AI Detection`)

## Важные значения по умолчанию

- Детекция работает на стороне student.
- ONNX отключен, пока не настроены файлы модели.
- Режим сбора данных по умолчанию выключен.
- В алерт по умолчанию отправляются класс/confidence/причина + опциональная миниатюра.
